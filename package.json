// ==================================================================================
//  ðŸŸ¢ GREEN CHIP V8 "COMPACT US" - ENTERPRISE TRADING ENGINE
//  ---------------------------------------------------------------------------------
//  New Capabilities:
//  [1] ðŸ‡ºðŸ‡¸ US TIMEZONE: Daily Recap set to America/New_York.
//  [2] ðŸ“‰ COMPACT UI: Minimized dead space, dense data display.
//  [3] ðŸ“‹ COPY CA: Interactive button to grab the Contract Address.
//  [4] ðŸ–¼ï¸ VISUALS: Auto-attaches Banners and Icons if available.
//  [5] ðŸ’° MCAP TRACKING: Gains are now reported in Market Cap, not Price.
//  ---------------------------------------------------------------------------------
//  Author: Gemini (AI) for GreenChip
//  Version: 8.1.0-COMPACT
// ==================================================================================

require('dotenv').config();
const { 
    Client, 
    GatewayIntentBits, 
    EmbedBuilder, 
    ActionRowBuilder, 
    ButtonBuilder, 
    ButtonStyle,
    InteractionType 
} = require('discord.js');
const axios = require('axios');
const express = require('express');
const moment = require('moment-timezone'); // Ensure 'npm install moment-timezone'

// ==================================================================================
//  âš™ï¸  CONFIGURATION MATRIX
// ==================================================================================

const CONFIG = {
    TIMEZONE: "America/New_York", // US Timezone
    
    // --- Strategy Filters ---
    FILTERS: {
        MIN_MCAP: 20000,
        MAX_MCAP: 55000,
        MIN_LIQ: 1500,
        MIN_VOL_H1: 500,
        MAX_AGE_MIN: 60,
        MIN_AGE_MIN: 1,
        REQUIRE_SOCIALS: true,
        ANTI_SPAM_NAMES: true
    },

    // --- Tracking ---
    TRACKER: {
        GAIN_TRIGGER_1: 45,
        GAIN_TRIGGER_2: 100,
        GAIN_TRIGGER_3: 500,
        STOP_LOSS: 0.90,
        RUG_CHECK_LIQ: 300,
        MAX_HOURS: 24
    },

    SYSTEM: {
        SCAN_DELAY_PROFILES: 15000,
        SCAN_DELAY_BOOSTS: 30000,
        SCAN_DELAY_SEARCH: 60000,
        TRACK_DELAY: 15000,
        QUEUE_DELAY: 3000,
        DAILY_CHECK_INTERVAL: 60000
    },

    ENDPOINTS: {
        PROFILES: "https://api.dexscreener.com/token-profiles/latest/v1",
        BOOSTS: "https://api.dexscreener.com/token-boosts/latest/v1",
        SEARCH: "https://api.dexscreener.com/latest/dex/search?q=solana",
        TOKENS: "https://api.dexscreener.com/latest/dex/tokens/"
    },

    URLS: {
        REFERRAL: "https://gmgn.ai/r/Greenchip"
    }
};

// ==================================================================================
//  ðŸ› ï¸  UTILITY TOOLKIT
// ==================================================================================

const Utils = {
    sleep: (ms) => new Promise(resolve => setTimeout(resolve, ms)),

    formatUSD: (n) => {
        if (!n || isNaN(n)) return '$0';
        if (n >= 1e9) return '$' + (n/1e9).toFixed(2) + 'B';
        if (n >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M';
        if (n >= 1e3) return '$' + (n/1e3).toFixed(1) + 'K';
        return '$' + n.toFixed(0);
    },

    getAge: (ts) => {
        const diff = Date.now() - ts;
        const m = Math.floor(diff / 60000);
        if (m < 60) return `${m}m`;
        return `${Math.floor(m/60)}h ${m%60}m`;
    },

    getHeaders: () => ({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Accept': 'application/json'
    }),

    log: (type, source, msg) => {
        const t = moment().tz(CONFIG.TIMEZONE).format('HH:mm:ss');
        console.log(`[${t}] ${type} [${source}] ${msg}`);
    }
};

// ==================================================================================
//  ðŸ§   STATE MANAGEMENT
// ==================================================================================

class StateManager {
    constructor() {
        this.activeTracks = new Map();
        this.history = new Set();
        this.processing = new Set();
        this.queue = [];
        this.dailyStats = new Map();
        this.lastReportDate = null;
        this.stats = { calls: 0, rugs: 0, start: Date.now() };
    }

    lockCoin(address) {
        if (this.history.has(address) || this.processing.has(address)) return false;
        this.processing.add(address);
        return true;
    }

    unlockCoin(address) {
        this.processing.delete(address);
    }

    finalizeCoin(address, data) {
        this.processing.delete(address);
        this.history.add(address);
        this.dailyStats.set(address, {
            name: data.name, symbol: data.symbol,
            entry: data.price, maxGain: 0,
            time: Date.now(), status: 'ACTIVE'
        });
        if (this.history.size > 10000) this.history.delete(this.history.values().next().value);
    }

    updateDailyPeak(address, gain, status = 'ACTIVE') {
        if (this.dailyStats.has(address)) {
            const stat = this.dailyStats.get(address);
            if (gain > stat.maxGain) stat.maxGain = gain;
            stat.status = status;
            this.dailyStats.set(address, stat);
        }
    }
}

const STATE = new StateManager();

// ==================================================================================
//  âš–ï¸  RISK ENGINE
// ==================================================================================

class RiskEngine {
    static analyze(pair) {
        const vol = pair.volume?.h1 || 0;
        const liq = pair.liquidity?.usd || 1;
        const fdv = pair.fdv || pair.marketCap || 0;
        const socials = pair.info?.socials || [];

        let hype = 0;
        if (vol / liq > 0.5) hype += 20;
        if (socials.length > 0) hype += 20;
        if (pair.info?.header) hype += 20; // Banner adds score

        let safe = true;
        if (fdv < CONFIG.FILTERS.MIN_MCAP || fdv > CONFIG.FILTERS.MAX_MCAP) safe = false;
        if (liq < CONFIG.FILTERS.MIN_LIQ || vol < CONFIG.FILTERS.MIN_VOL_H1) safe = false;
        if (CONFIG.FILTERS.REQUIRE_SOCIALS && socials.length === 0) safe = false;
        
        let status = 'NEW';
        if ((pair.dexId || '').includes('pump')) status = 'PUMP';
        if ((pair.dexId || '').includes('raydium')) status = 'RAY';

        return { safe, hype, status, vol, liq, fdv };
    }
}

// ==================================================================================
//  ðŸ“¡  SCANNERS
// ==================================================================================

async function scanProfiles() { await runScan(CONFIG.ENDPOINTS.PROFILES, 'PROFILE', CONFIG.SYSTEM.SCAN_DELAY_PROFILES); }
async function scanBoosts() { await runScan(CONFIG.ENDPOINTS.BOOSTS, 'BOOST', CONFIG.SYSTEM.SCAN_DELAY_BOOSTS); }

async function runScan(url, source, delay) {
    try {
        const res = await axios.get(url, { timeout: 5000, headers: Utils.getHeaders() });
        const list = res.data?.filter(p => p.chainId === 'solana').slice(0, 20) || [];
        if (list.length) await fetchAndProcess(list.map(p => p.tokenAddress), source);
    } catch (e) {}
    setTimeout(() => runScan(url, source, delay), delay);
}

async function scanSearch() {
    try {
        const res = await axios.get(CONFIG.ENDPOINTS.SEARCH, { timeout: 5000, headers: Utils.getHeaders() });
        (res.data?.pairs || []).forEach(p => processPair(p, 'SEARCH'));
    } catch (e) {}
    setTimeout(scanSearch, CONFIG.SYSTEM.SCAN_DELAY_SEARCH);
}

async function fetchAndProcess(addresses, source) {
    if (!addresses.length) return;
    try {
        const res = await axios.get(`${CONFIG.ENDPOINTS.TOKENS}${addresses.join(',')}`, { timeout: 5000, headers: Utils.getHeaders() });
        (res.data?.pairs || []).forEach(p => processPair(p, source));
    } catch (e) {}
}

function processPair(pair, source) {
    if (!pair?.baseToken || pair.chainId !== 'solana') return;
    const addr = pair.baseToken.address;

    if (!STATE.lockCoin(addr)) return;
    const analysis = RiskEngine.analyze(pair);
    
    // Age Check
    const ageMins = (Date.now() - pair.pairCreatedAt) / 60000;
    if (ageMins < CONFIG.FILTERS.MIN_AGE_MIN || ageMins > CONFIG.FILTERS.MAX_AGE_MIN || !analysis.safe) {
        STATE.unlockCoin(addr);
        return;
    }

    STATE.finalizeCoin(addr, { 
        name: pair.baseToken.name, 
        symbol: pair.baseToken.symbol, 
        price: parseFloat(pair.priceUsd) 
    });
    
    STATE.queue.push({ pair, analysis, source });
    Utils.log('FOUND', source, `${pair.baseToken.name}`);
}

// ==================================================================================
//  ðŸ’¬  DISCORD COMPACT SENDER
// ==================================================================================

const client = new Client({
    intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages, GatewayIntentBits.MessageContent]
});

async function processQueue() {
    if (STATE.queue.length === 0) { setTimeout(processQueue, 1000); return; }
    const item = STATE.queue.shift();
    await sendAlert(item.pair, item.analysis, item.source);
    setTimeout(processQueue, CONFIG.SYSTEM.QUEUE_DELAY);
}

async function sendAlert(pair, analysis, source) {
    const channel = client.channels.cache.get(process.env.CHANNEL_ID);
    if (!channel) return;

    const token = pair.baseToken;
    const socials = pair.info?.socials || [];
    
    // Compact Socials
    const links = socials.map(s => `[${s.type.toUpperCase()}](${s.url})`).join(' ') || 'âŒ';
    
    // Badges
    let badge = 'âš¡'; 
    if (source === 'BOOST') badge = 'ðŸš€';
    if (source === 'PROFILE') badge = 'ðŸ’Ž';

    // Compact Metrics Line
    const metrics = `**MCAP:** ${Utils.formatUSD(analysis.fdv)} â€¢ **Liq:** ${Utils.formatUSD(analysis.liq)} â€¢ **Vol:** ${Utils.formatUSD(analysis.vol)} â€¢ **Age:** ${Utils.getAge(pair.pairCreatedAt)}`;

    // Build Embed
    const embed = new EmbedBuilder()
        .setColor(source === 'BOOST' ? '#FFD700' : '#00D4FF')
        .setDescription(`
${badge} **[${token.name} (${token.symbol})](https://dexscreener.com/solana/${pair.pairAddress})**
${metrics}
**Links:** ${links} | **Source:** ${source} | **Score:** ${analysis.hype}/100
`)
        .setFooter({ text: `Green Chip V8 â€¢ ${moment().tz(CONFIG.TIMEZONE).format('h:mm A')}`, iconURL: client.user.displayAvatarURL() });

    // Add Profile Image (Thumbnail)
    if (pair.info?.imageUrl) {
        embed.setThumbnail(pair.info.imageUrl);
    }

    // Add Banner (Main Image)
    if (pair.info?.header) {
        embed.setImage(pair.info.header);
    }

    // Buttons
    const row = new ActionRowBuilder().addComponents(
        new ButtonBuilder()
            .setCustomId(`copy_${token.address}`)
            .setLabel('ðŸ“‹ Copy CA')
            .setStyle(ButtonStyle.Secondary),
        new ButtonBuilder()
            .setLabel('ðŸ’° Buy GMGN')
            .setStyle(ButtonStyle.Link)
            .setURL(CONFIG.URLS.REFERRAL)
    );

    try {
        const msg = await channel.send({ embeds: [embed], components: [row] });
        
        STATE.activeTracks.set(token.address, {
            name: token.name,
            symbol: token.symbol,
            entryPrice: parseFloat(pair.priceUsd),
            entryMcap: analysis.fdv, // Store MCAP for gains reporting
            maxGain: 0,
            msgId: msg.id,
            chanId: channel.id,
            t1: false, t2: false, t3: false,
            start: Date.now()
        });
        
        STATE.stats.calls++;
    } catch (e) { console.error(e); }
}

// ðŸ–±ï¸ Button Interaction Handler (Copy CA)
client.on('interactionCreate', async interaction => {
    if (!interaction.isButton()) return;
    if (interaction.customId.startsWith('copy_')) {
        const ca = interaction.customId.split('_')[1];
        await interaction.reply({ content: `\`${ca}\``, ephemeral: true });
    }
});

// ==================================================================================
//  ðŸ“…  US TIMEZONE DAILY RECAP
// ==================================================================================

function initDailyScheduler() {
    setInterval(async () => {
        // Use moment-timezone for US time
        const now = moment().tz(CONFIG.TIMEZONE);
        
        // 12:00 AM (Midnight) in US Time
        if (now.hour() === 0 && now.minute() === 0) {
            const todayStr = now.format("YYYY-MM-DD");
            
            if (STATE.lastReportDate !== todayStr) {
                await sendDailyRecap();
                STATE.lastReportDate = todayStr;
                STATE.dailyStats.clear();
            }
        }
    }, CONFIG.SYSTEM.DAILY_CHECK_INTERVAL);
}

async function sendDailyRecap() {
    const channel = client.channels.cache.get(process.env.CHANNEL_ID);
    if (!channel) return;

    const sorted = Array.from(STATE.dailyStats.values())
        .sort((a, b) => b.maxGain - a.maxGain)
        .slice(0, 10);

    if (!sorted.length) return;

    const yesterday = moment().tz(CONFIG.TIMEZONE).subtract(1, 'days').format('MMM Do');
    let desc = `**ðŸ‡ºðŸ‡¸ DAILY RECAP: ${yesterday}**\n\n`;

    sorted.forEach((c, i) => {
        let icon = 'ðŸŸ¢';
        if (c.maxGain > 100) icon = 'ðŸš€';
        if (c.status === 'RUG') icon = 'ðŸ’€';
        desc += `\`#${i+1}\` ${icon} **${c.name}** (+${c.maxGain.toFixed(0)}%)\n`;
    });

    const embed = new EmbedBuilder()
        .setColor('#FFD700')
        .setTitle(`ðŸ† TOP PERFORMERS`)
        .setDescription(desc)
        .setFooter({ text: 'Green Chip V8 â€¢ Daily Summary' });

    await channel.send({ embeds: [embed] });
}

// ==================================================================================
//  ðŸ“ˆ  TRACKER (MCAP BASED)
// ==================================================================================

async function runTracker() {
    if (STATE.activeTracks.size === 0) { setTimeout(runTracker, CONFIG.SYSTEM.TRACK_DELAY); return; }

    for (const [addr, data] of STATE.activeTracks) {
        try {
            if (Date.now() - data.start > (CONFIG.TRACKER.MAX_HOURS * 3600000)) {
                STATE.activeTracks.delete(addr); continue;
            }

            const res = await axios.get(`${CONFIG.ENDPOINTS.TOKENS}${addr}`, { timeout: 3000, headers: Utils.getHeaders() });
            const pair = res.data?.pairs?.[0];
            if (!pair) continue;

            const currPrice = parseFloat(pair.priceUsd);
            const currMcap = pair.fdv || pair.marketCap || 0;
            const liq = pair.liquidity?.usd || 0;
            
            // Gain calculation
            const gain = ((currPrice - data.entryPrice) / data.entryPrice) * 100;

            STATE.updateDailyPeak(addr, gain, 'ACTIVE');

            // Rug Check
            if (currPrice < (data.entryPrice * (1 - CONFIG.TRACKER.STOP_LOSS)) || liq < CONFIG.TRACKER.RUG_CHECK_LIQ) {
                await sendUpdate(data, currMcap, gain, 'RUG');
                STATE.updateDailyPeak(addr, gain, 'RUG');
                STATE.activeTracks.delete(addr);
                continue;
            }

            if (gain > data.maxGain) data.maxGain = gain;

            if (gain >= CONFIG.TRACKER.GAIN_TRIGGER_1 && !data.t1) {
                await sendUpdate(data, currMcap, gain, 'GAIN'); data.t1 = true;
            } else if (gain >= CONFIG.TRACKER.GAIN_TRIGGER_2 && !data.t2) {
                await sendUpdate(data, currMcap, gain, 'MOON'); data.t2 = true;
            } else if (gain >= CONFIG.TRACKER.GAIN_TRIGGER_3 && !data.t3) {
                await sendUpdate(data, currMcap, gain, 'GOD'); data.t3 = true;
            }

        } catch (e) {}
        await Utils.sleep(500);
    }
    setTimeout(runTracker, CONFIG.SYSTEM.TRACK_DELAY);
}

async function sendUpdate(data, currentMcap, gain, type) {
    const channel = client.channels.cache.get(data.chanId);
    if (!channel) return;
    try {
        const msg = await channel.messages.fetch(data.msgId);
        if (!msg) return;

        let color = '#00FF00'; let title = `ðŸš€ ${gain.toFixed(0)}%`;
        if (type === 'MOON') { color = '#00D4FF'; title = `ðŸŒ• ${gain.toFixed(0)}%`; }
        if (type === 'RUG') { color = '#FF0000'; title = `ðŸš¨ RUG`; }

        // COMPACT MCAP UPDATE
        const entryStr = Utils.formatUSD(data.entryMcap);
        const currStr = Utils.formatUSD(currentMcap);
        
        const desc = type === 'RUG' 
            ? `ðŸ’€ **Stopped Tracking** (Liquidity pulled or -90%)`
            : `**${data.name}:** ${entryStr} âž” **${currStr}**\n[**ðŸ’° SELL**](${CONFIG.URLS.REFERRAL})`;

        const embed = new EmbedBuilder().setColor(color).setTitle(title).setDescription(desc);
        await msg.reply({ embeds: [embed] });
        
    } catch (e) { console.log(e.message); }
}

// Start
client.once('ready', () => {
    Utils.log('SUCCESS', 'System', `Online as ${client.user.tag}`);
    scanProfiles(); scanBoosts(); scanSearch();
    runTracker(); processQueue(); initDailyScheduler();
});

client.login(process.env.DISCORD_TOKEN);
